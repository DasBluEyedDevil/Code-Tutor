<UserControl x:Class="CodeTutor.Wpf.Controls.TutorChat"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:controls="clr-namespace:CodeTutor.Wpf.Controls"
             xmlns:behaviors="clr-namespace:CodeTutor.Wpf.Behaviors"
             Width="380"
             Background="{StaticResource BackgroundDarkBrush}"
             behaviors:AnimationBehaviors.EnableFadeInOnLoad="True">

    <UserControl.Resources>
        <!-- User message bubble -->
        <Style x:Key="UserMessageStyle" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource AccentBlueBrush}"/>
            <Setter Property="CornerRadius" Value="12,12,4,12"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Margin" Value="40,4,8,4"/>
            <Setter Property="HorizontalAlignment" Value="Right"/>
            <Setter Property="MaxWidth" Value="300"/>
        </Style>

        <!-- Assistant message bubble -->
        <Style x:Key="AssistantMessageStyle" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource BackgroundLightBrush}"/>
            <Setter Property="CornerRadius" Value="12,12,12,4"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Margin" Value="8,4,40,4"/>
            <Setter Property="HorizontalAlignment" Value="Left"/>
            <Setter Property="MaxWidth" Value="300"/>
        </Style>

        <Storyboard x:Key="ThinkingDotsStoryboard" RepeatBehavior="Forever">
            <DoubleAnimation Storyboard.TargetName="Dot1"
                             Storyboard.TargetProperty="Opacity"
                             From="0.2" To="1"
                             Duration="0:0:0.6"
                             AutoReverse="True" />
            <DoubleAnimation Storyboard.TargetName="Dot2"
                             Storyboard.TargetProperty="Opacity"
                             From="0.2" To="1"
                             Duration="0:0:0.6"
                             BeginTime="0:0:0.2"
                             AutoReverse="True" />
            <DoubleAnimation Storyboard.TargetName="Dot3"
                             Storyboard.TargetProperty="Opacity"
                             From="0.2" To="1"
                             Duration="0:0:0.6"
                             BeginTime="0:0:0.4"
                             AutoReverse="True" />
        </Storyboard>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header with glass effect -->
        <Border Grid.Row="0"
                Background="{StaticResource GlassDarkBrush}"
                BorderBrush="{StaticResource BorderSubtleBrush}"
                BorderThickness="0,0,0,1"
                Padding="12,10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Tutor icon -->
                <Ellipse Grid.Column="0" Width="32" Height="32"
                         Fill="{StaticResource AccentPurpleBrush}" Margin="0,0,10,0"/>

                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                    <TextBlock Text="AI Tutor"
                               FontWeight="SemiBold"
                               Foreground="{StaticResource TextPrimaryBrush}"/> 
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock x:Name="StatusText"
                                   Text="Ready to help"
                                   FontSize="11"
                                   Foreground="{StaticResource TextSecondaryBrush}"/>
                        <StackPanel x:Name="ThinkingIndicator"
                                    Orientation="Horizontal"
                                    Margin="6,0,0,0"
                                    Visibility="Collapsed">
                            <Ellipse x:Name="Dot1"
                                     Width="4" Height="4"
                                     Fill="{StaticResource AccentPurpleBrush}"
                                     Opacity="0.2"
                                     Margin="0,0,2,0" />
                            <Ellipse x:Name="Dot2"
                                     Width="4" Height="4"
                                     Fill="{StaticResource AccentPurpleBrush}"
                                     Opacity="0.2"
                                     Margin="0,0,2,0" />
                            <Ellipse x:Name="Dot3"
                                     Width="4" Height="4"
                                     Fill="{StaticResource AccentPurpleBrush}"
                                     Opacity="0.2" />
                        </StackPanel>
                    </StackPanel>
                </StackPanel>

                <!-- Uninstall button -->
                <Button Grid.Column="2"
                        x:Name="UninstallButton"
                        Content="&#xE74D;"
                        FontFamily="Segoe MDL2 Assets"
                        FontSize="14"
                        Style="{StaticResource IconButton}"
                        Width="32" Height="32"
                        ToolTip="Uninstall model to free disk space"
                        Click="UninstallButton_Click"/>

                <!-- Close button -->
                <Button Grid.Column="3"
                        x:Name="CloseButton"
                        Content="&#xE8BB;"
                        FontFamily="Segoe MDL2 Assets"
                        FontSize="14"
                        Style="{StaticResource IconButton}"
                        Width="32" Height="32"
                        Click="CloseButton_Click"/>
            </Grid>
        </Border>

        <!-- Loading/Download overlay -->
        <Border x:Name="LoadingOverlay"
                Grid.Row="1"
                Background="{StaticResource BackgroundDarkBrush}"
                Visibility="Collapsed"
                Panel.ZIndex="10">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Margin="20">
                <!-- Download prompt (shown when model missing) -->
                <StackPanel x:Name="DownloadPromptPanel" Visibility="Collapsed">
                    <TextBlock Text="&#xE896;"
                               FontFamily="Segoe MDL2 Assets"
                               FontSize="48"
                               HorizontalAlignment="Center"
                               Foreground="{StaticResource AccentPurpleBrush}"
                               Margin="0,0,0,16"/>
                    <TextBlock Text="AI Model Required"
                               FontSize="16"
                               FontWeight="SemiBold"
                               HorizontalAlignment="Center"
                               Foreground="{StaticResource TextPrimaryBrush}"/>
                    <TextBlock Text="The Qwen2.5-Coder-7B model (~4.5GB) needs to be downloaded to enable the AI tutor."
                               TextWrapping="Wrap"
                               TextAlignment="Center"
                               Margin="0,8,0,16"
                               Foreground="{StaticResource TextSecondaryBrush}"/>
                    <Button x:Name="DownloadModelButton"
                            Content="Download Model"
                            Style="{StaticResource PrimaryButton}"
                            Click="DownloadModelButton_Click"/>
                </StackPanel>

                <!-- Download progress (shown during download) -->
                <StackPanel x:Name="DownloadProgressPanel" Visibility="Collapsed">
                    <TextBlock x:Name="DownloadStatusText"
                               Text="Downloading model..."
                               HorizontalAlignment="Center"
                               Foreground="{StaticResource TextPrimaryBrush}"
                               Margin="0,0,0,12"/>
                    <ProgressBar x:Name="DownloadProgress"
                                 Width="280" Height="8"
                                 Minimum="0" Maximum="100"
                                 Foreground="{StaticResource AccentBlueBrush}"
                                 Background="{StaticResource BackgroundLightBrush}"/>
                    <TextBlock x:Name="DownloadDetailText"
                               Text="0 MB / 0 MB"
                               HorizontalAlignment="Center"
                               Margin="0,8,0,12"
                               FontSize="11"
                               Foreground="{StaticResource TextSecondaryBrush}"/>
                    <Button x:Name="CancelDownloadButton"
                            Content="Cancel"
                            Style="{StaticResource SecondaryButton}"
                            Padding="16,8"
                            Click="CancelDownloadButton_Click"/>
                </StackPanel>

                <!-- Loading model (shown when loading after download) -->
                <StackPanel x:Name="LoadingModelPanel" Visibility="Collapsed">
                    <ProgressBar x:Name="LoadingProgress"
                                 Width="200" Height="4"
                                 Minimum="0" Maximum="100"
                                 Foreground="{StaticResource AccentBlueBrush}"
                                 Background="{StaticResource BackgroundLightBrush}"/>
                    <TextBlock Text="Loading AI Tutor..."
                               Margin="0,12,0,0"
                               HorizontalAlignment="Center"
                               Foreground="{StaticResource TextSecondaryBrush}"/>
                </StackPanel>
            </StackPanel>
        </Border>

        <!-- Messages area -->
        <ScrollViewer Grid.Row="1"
                      x:Name="MessagesScrollViewer"
                      VerticalScrollBarVisibility="Auto"
                      Padding="4">
            <ItemsControl x:Name="MessagesPanel">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <controls:ChatMessageBubble Message="{Binding}"/>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <!-- Quick actions -->
        <Border Grid.Row="2"
                Background="{StaticResource GlassMediumBrush}"
                BorderBrush="{StaticResource BorderSubtleBrush}"
                BorderThickness="0,1,0,0"
                Padding="8,8">
            <WrapPanel x:Name="QuickActionsPanel">
                <Button Content="Explain this code"
                        Style="{StaticResource QuickActionButton}"
                        Tag="explain"
                        Click="QuickAction_Click"/>
                <Button Content="Help with error"
                        Style="{StaticResource QuickActionButton}"
                        Tag="error"
                        Click="QuickAction_Click"/>
                <Button Content="Give me a hint"
                        Style="{StaticResource QuickActionButton}"
                        Tag="hint"
                        Click="QuickAction_Click"/>
            </WrapPanel>
        </Border>

        <!-- Input area -->
        <Border Grid.Row="3"
                Background="{StaticResource GlassMediumBrush}"
                BorderBrush="{StaticResource BorderSubtleBrush}"
                BorderThickness="0,1,0,0"
                Padding="10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBox x:Name="InputTextBox"
                         Grid.Column="0"
                         Padding="12,10"
                         FontSize="13"
                         Background="{StaticResource BackgroundDarkBrush}"
                         Foreground="{StaticResource TextPrimaryBrush}"
                         BorderBrush="{StaticResource BorderDefaultBrush}"
                         BorderThickness="1"
                         AcceptsReturn="False"
                         TextWrapping="Wrap"
                         MaxHeight="80"
                         VerticalScrollBarVisibility="Auto"
                         KeyDown="InputTextBox_KeyDown">
                    <TextBox.Style>
                        <Style TargetType="TextBox">
                            <Style.Triggers>
                                <Trigger Property="Text" Value="">
                                    <Setter Property="Tag" Value="Ask me anything..."/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </TextBox.Style>
                </TextBox>

                <Button x:Name="SendButton"
                        Grid.Column="1"
                        Content="&#xE724;"
                        FontFamily="Segoe MDL2 Assets"
                        FontSize="16"
                        Width="40" Height="40"
                        Margin="8,0,0,0"
                        Style="{StaticResource PrimaryButton}"
                        Padding="0"
                        Click="SendButton_Click"/>
            </Grid>
        </Border>
    </Grid>
</UserControl>
