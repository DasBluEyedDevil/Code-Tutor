---
type: "EXAMPLE"
title: "Section 2: Implementing Google Sign-In in Flutter"
---

With Firebase configured, let us implement Google Sign-In in your Flutter app. We will use the official google_sign_in package and integrate it with your Serverpod backend.

**Step 1: Add Dependencies**

Add to your `pubspec.yaml`:

```yaml
dependencies:
  google_sign_in: ^6.2.1
  firebase_core: ^2.24.2
  firebase_auth: ^4.16.0
```

Run `flutter pub get`.

**Step 2: Initialize Firebase**

Update your `lib/main.dart`:

```dart
import 'package:firebase_core/firebase_core.dart';
import 'firebase_options.dart'; // Generated by flutterfire configure

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  // Initialize Firebase
  await Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );
  
  runApp(const ProviderScope(child: MyApp()));
}
```

Generate `firebase_options.dart` using FlutterFire CLI:

```bash
# Install FlutterFire CLI if not already installed
dart pub global activate flutterfire_cli

# Configure Firebase (generates firebase_options.dart)
flutterfire configure
```

**Step 3: Create Google Auth Service**

Create `lib/services/google_auth_service.dart`:

```dart
import 'package:firebase_auth/firebase_auth.dart';
import 'package:google_sign_in/google_sign_in.dart';
import 'package:flutter/foundation.dart';

/// Result of a Google Sign-In attempt.
class GoogleSignInResult {
  final bool success;
  final String? idToken;
  final String? accessToken;
  final String? email;
  final String? displayName;
  final String? photoUrl;
  final String? errorMessage;
  final String? errorCode;
  
  GoogleSignInResult({
    required this.success,
    this.idToken,
    this.accessToken,
    this.email,
    this.displayName,
    this.photoUrl,
    this.errorMessage,
    this.errorCode,
  });
  
  factory GoogleSignInResult.success({
    required String idToken,
    required String accessToken,
    String? email,
    String? displayName,
    String? photoUrl,
  }) {
    return GoogleSignInResult(
      success: true,
      idToken: idToken,
      accessToken: accessToken,
      email: email,
      displayName: displayName,
      photoUrl: photoUrl,
    );
  }
  
  factory GoogleSignInResult.failure(String message, {String? code}) {
    return GoogleSignInResult(
      success: false,
      errorMessage: message,
      errorCode: code,
    );
  }
  
  factory GoogleSignInResult.cancelled() {
    return GoogleSignInResult(
      success: false,
      errorMessage: 'Sign-in was cancelled',
      errorCode: 'cancelled',
    );
  }
}

/// Service handling Google Sign-In authentication.
class GoogleAuthService {
  final GoogleSignIn _googleSignIn = GoogleSignIn(
    scopes: [
      'email',
      'profile',
    ],
  );
  
  final FirebaseAuth _firebaseAuth = FirebaseAuth.instance;
  
  /// Initiates Google Sign-In flow and returns tokens for backend verification.
  Future<GoogleSignInResult> signIn() async {
    try {
      // Trigger the Google Sign-In flow
      final GoogleSignInAccount? googleUser = await _googleSignIn.signIn();
      
      // User cancelled the sign-in
      if (googleUser == null) {
        return GoogleSignInResult.cancelled();
      }
      
      // Obtain auth details from the request
      final GoogleSignInAuthentication googleAuth = 
          await googleUser.authentication;
      
      // Validate we have the required tokens
      if (googleAuth.idToken == null || googleAuth.accessToken == null) {
        return GoogleSignInResult.failure(
          'Failed to obtain authentication tokens from Google',
          code: 'missing_tokens',
        );
      }
      
      // Create Firebase credential (optional - for Firebase Auth integration)
      final credential = GoogleAuthProvider.credential(
        accessToken: googleAuth.accessToken,
        idToken: googleAuth.idToken,
      );
      
      // Sign in to Firebase (this step is optional if you only use Serverpod)
      // You can skip this if you only want to verify with Serverpod
      await _firebaseAuth.signInWithCredential(credential);
      
      return GoogleSignInResult.success(
        idToken: googleAuth.idToken!,
        accessToken: googleAuth.accessToken!,
        email: googleUser.email,
        displayName: googleUser.displayName,
        photoUrl: googleUser.photoUrl,
      );
    } on FirebaseAuthException catch (e) {
      return _handleFirebaseError(e);
    } catch (e) {
      if (kDebugMode) {
        print('Google Sign-In error: $e');
      }
      return GoogleSignInResult.failure(
        'An unexpected error occurred during sign-in',
        code: 'unknown_error',
      );
    }
  }
  
  /// Signs out from Google and Firebase.
  Future<void> signOut() async {
    await Future.wait([
      _googleSignIn.signOut(),
      _firebaseAuth.signOut(),
    ]);
  }
  
  /// Disconnects the Google account (revokes access).
  Future<void> disconnect() async {
    await _googleSignIn.disconnect();
    await _firebaseAuth.signOut();
  }
  
  /// Checks if user is currently signed in with Google.
  Future<bool> isSignedIn() async {
    return await _googleSignIn.isSignedIn();
  }
  
  /// Gets the currently signed-in Google account, if any.
  GoogleSignInAccount? get currentUser => _googleSignIn.currentUser;
  
  /// Handles Firebase Auth exceptions.
  GoogleSignInResult _handleFirebaseError(FirebaseAuthException e) {
    switch (e.code) {
      case 'account-exists-with-different-credential':
        return GoogleSignInResult.failure(
          'An account already exists with this email using a different sign-in method. '
          'Try signing in with email and password instead.',
          code: 'account_exists',
        );
      case 'invalid-credential':
        return GoogleSignInResult.failure(
          'The authentication credential is invalid. Please try again.',
          code: 'invalid_credential',
        );
      case 'operation-not-allowed':
        return GoogleSignInResult.failure(
          'Google Sign-In is not enabled. Please contact support.',
          code: 'not_enabled',
        );
      case 'user-disabled':
        return GoogleSignInResult.failure(
          'This account has been disabled. Please contact support.',
          code: 'user_disabled',
        );
      default:
        return GoogleSignInResult.failure(
          'Authentication failed. Please try again.',
          code: e.code,
        );
    }
  }
}
```

**Step 4: Add Riverpod Provider**

Add to your `lib/providers/auth_provider.dart`:

```dart
/// Google auth service provider
final googleAuthServiceProvider = Provider<GoogleAuthService>((ref) {
  return GoogleAuthService();
});
```

The Google Sign-In implementation is now complete. In the next section, we will set up Apple Sign-In.

