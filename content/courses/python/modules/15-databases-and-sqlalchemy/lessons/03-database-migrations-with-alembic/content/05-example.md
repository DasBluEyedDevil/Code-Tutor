---
type: "EXAMPLE"
title: "Migration File Anatomy"
---

**Understanding a migration file:**

Every migration file contains:
1. **Docstring** - Description and metadata
2. **Revision IDs** - Unique ID and link to previous migration
3. **upgrade()** - Function to apply the migration
4. **downgrade()** - Function to reverse the migration

**Common Operations:**
```python
# Create table
op.create_table('name', columns...)

# Drop table
op.drop_table('name')

# Add column
op.add_column('table', sa.Column('name', sa.Type()))

# Drop column
op.drop_column('table', 'column_name')

# Create index
op.create_index('ix_name', 'table', ['column'])

# Add foreign key
op.create_foreign_key('fk_name', 'source', 'target', ['col'], ['id'])
```

```python
# migrations/versions/abc123def456_add_transactions.py

"""add transactions table

Revision ID: abc123def456
Revises: 9876fedcba  (previous migration, None if first)
Create Date: 2025-01-15 10:30:00.000000

"""
from alembic import op
import sqlalchemy as sa

# Revision identifiers
revision = 'abc123def456'
down_revision = '9876fedcba'  # None if this is the first migration
branch_labels = None
depends_on = None


def upgrade() -> None:
    """Apply the migration - add transactions table."""
    
    # Create the transactions table
    op.create_table(
        'transactions',
        sa.Column('id', sa.Integer(), primary_key=True),
        sa.Column('amount', sa.Float(), nullable=False),
        sa.Column('category', sa.String(50), nullable=False),
        sa.Column('description', sa.String(200), nullable=True),
        sa.Column('user_id', sa.Integer(), nullable=False),
        sa.Column(
            'created_at',
            sa.DateTime(),
            server_default=sa.func.now()
        ),
        # Foreign key constraint
        sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    )
    
    # Create index for faster queries
    op.create_index(
        'ix_transactions_user_id',
        'transactions',
        ['user_id']
    )
    
    # Create index for category filtering
    op.create_index(
        'ix_transactions_category',
        'transactions',
        ['category']
    )


def downgrade() -> None:
    """Reverse the migration - remove transactions table."""
    
    # Drop indexes first (reverse order of creation)
    op.drop_index('ix_transactions_category', 'transactions')
    op.drop_index('ix_transactions_user_id', 'transactions')
    
    # Drop the table
    op.drop_table('transactions')


# Demonstration
print("=== Migration File Structure ===")
print("""
Key components:

1. DOCSTRING - Description and metadata
   '''add transactions table
   Revision ID: abc123
   Revises: prev123
   '''

2. REVISION IDS
   revision = 'abc123'        # This migration's ID
   down_revision = 'prev123'  # Previous migration (chain)

3. UPGRADE FUNCTION
   def upgrade():
       op.create_table(...)
       op.add_column(...)
       op.create_index(...)

4. DOWNGRADE FUNCTION (reverse of upgrade!)
   def downgrade():
       op.drop_index(...)   # Reverse order!
       op.drop_column(...)
       op.drop_table(...)
""")

print("\nCommon operations:")
print("  op.create_table()     / op.drop_table()")
print("  op.add_column()       / op.drop_column()")
print("  op.alter_column()     - Change column properties")
print("  op.create_index()     / op.drop_index()")
print("  op.create_foreign_key() / op.drop_constraint()")

print("\nBest practices:")
print("  - Always test downgrade before deploying")
print("  - Review autogenerated migrations")
print("  - Use descriptive migration messages")
```
