---
phase: 08-ai-tutor-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - native-app-wpf/CodeTutor.Wpf.csproj
  - native-app-wpf/Services/Phi4TutorService.cs
  - native-app-wpf/Services/ITutorService.cs
autonomous: true

must_haves:
  truths:
    - ONNX Runtime GenAI package upgraded from 0.5.2 to 0.11.4
    - Phi-4 model loads and runs inference successfully on new runtime
    - All existing tutor functionality preserved (streaming, context, cancellation)
    - No breaking changes in public ITutorService interface
  artifacts:
    - path: native-app-wpf/CodeTutor.Wpf.csproj
      provides: Updated package reference (0.11.4)
      contains: "Microsoft.ML.OnnxRuntimeGenAI.DirectML" Version="0.11.4"
    - path: native-app-wpf/Services/Phi4TutorService.cs
      provides: Compatible implementation using 0.11.x API patterns
      min_lines: 150
    - path: native-app-wpf/Services/ITutorService.cs
      provides: Unchanged public interface (backward compatible)
  key_links:
    - from: Phi4TutorService.BuildPrompt
      to: Phi-4 model inference
      via: Generator/GeneratorParams API
      pattern: "new Generator.*SetInputSequences"
---

<objective>
Upgrade ONNX Runtime GenAI from version 0.5.2 to 0.11.4 (current stable) and verify Phi-4 model inference works correctly.

Purpose: The current 0.5.2 version is 12 months and 6 releases behind. Upgrading provides bug fixes, performance improvements, and new features. This is foundational work that must complete before enhancing tutor behavior.
Output: Updated csproj with 0.11.4, refactored Phi4TutorService compatible with new API, verified model loading and inference.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@native-app-wpf/CodeTutor.Wpf.csproj
@native-app-wpf/Services/ITutorService.cs
@native-app-wpf/Services/Phi4TutorService.cs

## Current State

**Existing ONNX Runtime GenAI version:** 0.5.2 (November 2024)
**Target version:** 0.11.4 (December 2025) - 6 versions behind

**Key API changes between 0.5.2 and 0.11.x:**
- `generator.AppendTokenSequences(tokens)` replaced with `generatorParams.SetInputSequences(tokens)`
- `GeneratorParams` now requires explicit input sequence setting before creating Generator
- Token streaming patterns remain similar but initialization order changed
- Model/Tokenizer disposal patterns unchanged

**Current implementation patterns in Phi4TutorService:**
- Uses `GeneratorParams.SetSearchOption()` for parameters
- Uses `Tokenizer.Encode()` for prompt encoding
- Uses `Generator.ComputeLogits()` and `GenerateNextToken()` for streaming
- Uses `generator.GetSequence(0)` to get output tokens
- Phi-4 chat template: `<|system|>...<|end|><|user|>...<|end|><|assistant|>`

**Critical compatibility notes from 0.11.x documentation:**
- The `OgaHandle` pattern is recommended for resource management
- `SetInputSequences` must be called BEFORE creating Generator
- DirectML execution provider auto-detects GPU
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update NuGet package reference to 0.11.4</name>
  <files>native-app-wpf/CodeTutor.Wpf.csproj</files>
  <action>
Update the ONNX Runtime GenAI package reference from 0.5.2 to 0.11.4:

1. Open native-app-wpf/CodeTutor.Wpf.csproj
2. Find: `&lt;PackageReference Include="Microsoft.ML.OnnxRuntimeGenAI.DirectML" Version="0.5.2" /&gt;`
3. Replace with: `&lt;PackageReference Include="Microsoft.ML.OnnxRuntimeGenAI.DirectML" Version="0.11.4" /&gt;`

Do NOT change any other package references. Do NOT modify project structure.
  </action>
  <verify>grep -q 'Version="0.11.4"' native-app-wpf/CodeTutor.Wpf.csproj && echo "Package updated"</verify>
  <done>csproj contains Microsoft.ML.OnnxRuntimeGenAI.DirectML Version="0.11.4"</done>
</task>

<task type="auto">
  <name>Task 2: Refactor Phi4TutorService for 0.11.x API compatibility</name>
  <files>native-app-wpf/Services/Phi4TutorService.cs</files>
  <action>
Refactor Phi4TutorService to use 0.11.x API patterns. The key change is in the SendMessageAsync method where Generator initialization happens:

**OLD pattern (0.5.2):**
```csharp
using var tokens = _tokenizer!.Encode(prompt);
using var generatorParams = new GeneratorParams(_model!);
generatorParams.SetSearchOption("max_length", 2048);
// ... other options
using var generator = new Generator(_model!, generatorParams);
generator.AppendTokenSequences(tokens);  // REMOVED in 0.11.x
```

**NEW pattern (0.11.x):**
```csharp
using var tokens = _tokenizer!.Encode(prompt);
using var generatorParams = new GeneratorParams(_model!);
generatorParams.SetSearchOption("max_length", 2048);
// ... other options
generatorParams.SetInputSequences(tokens);  // NEW in 0.11.x - call BEFORE creating Generator
using var generator = new Generator(_model!, generatorParams);
// No AppendTokenSequences call needed
```

Make these specific changes:
1. Keep all existing using statements and class structure
2. Keep Model, Tokenizer, Generator field declarations
3. Keep LoadModelAsync method unchanged
4. In SendMessageAsync:
   - Keep prompt building logic (BuildPrompt)
   - Keep tokenizer.Encode call
   - Keep GeneratorParams creation and SetSearchOption calls
   - ADD: `generatorParams.SetInputSequences(tokens);` BEFORE creating Generator
   - REMOVE: Any `generator.AppendTokenSequences(tokens)` call
   - Keep the Generator creation and streaming loop exactly as is
5. Keep BuildPrompt, GetLastGeneratedToken, UpdateProgress, UnloadModel, Dispose unchanged

The streaming loop using `generator.ComputeLogits()`, `generator.GenerateNextToken()`, and `generator.GetSequence(0)` remains unchanged.
  </action>
  <verify>grep -q "SetInputSequences" native-app-wpf/Services/Phi4TutorService.cs && echo "API updated"</verify>
  <done>Phi4TutorService uses SetInputSequences pattern, no AppendTokenSequences references remain</done>
</task>

<task type="auto">
  <name>Task 3: Build project to verify compilation</name>
  <files>native-app-wpf/</files>
  <action>
Build the WPF project to verify the upgraded package and refactored code compile successfully:

1. Restore NuGet packages: `dotnet restore native-app-wpf/CodeTutor.Wpf.csproj`
2. Build the project: `dotnet build native-app-wpf/CodeTutor.Wpf.csproj --configuration Release`

If build fails:
- Check for any API changes not accounted for
- Review error messages for missing methods or changed signatures
- The most likely issues are:
  - Missing SetInputSequences call
  - Attempting to call removed AppendTokenSequences
  - Changed namespace or type names

Do NOT run the application (requires model files). Just verify compilation succeeds.
  </action>
  <verify>dotnet build native-app-wpf/CodeTutor.Wpf.csproj --configuration Release -v quiet | grep -q "Build succeeded"</verify>
  <done>Build succeeds with 0 errors, 0 warnings related to ONNX Runtime</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Verify Phi-4 model inference works</name>
  <what-built>
Updated ONNX Runtime GenAI package (0.11.4) and refactored Phi4TutorService with new API patterns.
  </what-built>
  <how-to-verify>
1. Launch the Code Tutor desktop application: `dotnet run --project native-app-wpf/CodeTutor.Wpf.csproj`
2. Navigate to any lesson with AI tutor available
3. Open the AI tutor panel
4. If model not downloaded, download it (~2.5GB)
5. Wait for model to load (progress bar should complete)
6. Send a test message: "Hello, can you help me understand variables?"
7. Verify:
   - [ ] Model loads without errors
   - [ ] Response streams token by token (not all at once)
   - [ ] Response is coherent and helpful
   - [ ] No exceptions in console/output
   - [ ] Quick action buttons work (Explain this code, Help with error, Give me a hint)
  </how-to-verify>
  <resume-signal>Type "approved" if model loads and responds correctly, or describe any errors/issues</resume-signal>
</task>

</tasks>

<verification>
Overall phase checks:
- [ ] Package reference shows 0.11.4 in csproj
- [ ] Phi4TutorService compiles without errors
- [ ] SetInputSequences API pattern used correctly
- [ ] No references to removed AppendTokenSequences API
- [ ] Human verified model loads and inference works
</verification>

<success_criteria>
- ONNX Runtime GenAI upgraded from 0.5.2 to 0.11.4
- Phi4TutorService refactored for 0.11.x API compatibility
- Build succeeds with no errors
- Phi-4 model loads and generates responses correctly
- All existing functionality preserved (streaming, cancellation, context)
</success_criteria>

<output>
After completion, create `.planning/phases/08-ai-tutor-enhancement/08-01-SUMMARY.md`
</output>
