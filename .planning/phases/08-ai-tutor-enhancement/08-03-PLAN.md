---
phase: 08-ai-tutor-enhancement
plan: 03
type: execute
wave: 2
depends_on: [08-02]
files_modified:
  - native-app-wpf/Controls/TutorChat.xaml
  - native-app-wpf/Controls/TutorChat.xaml.cs
  - native-app-wpf/Models/HintLevel.cs
autonomous: true

must_haves:
  truths:
    - Tutor provides 3-level progressive hints (nudge, guidance, partial solution)
    - Hint level increases when student asks for more help
    - Debug assistance triggered by execution errors
    - UI has explicit hint request buttons ("I need a hint", "Give me more help")
    - Tutor tracks hint level per challenge and resets on new challenge
  artifacts:
    - path: native-app-wpf/Models/HintLevel.cs
      provides: Enum defining hint levels
      exports: ["None", "Nudge", "Guidance", "PartialSolution"]
    - path: native-app-wpf/Controls/TutorChat.xaml
      provides: UI for progressive hint requests
      contains: "Need a hint", "More help"
    - path: native-app-wpf/Controls/TutorChat.xaml.cs
      provides: Hint level tracking and escalation logic
      pattern: "IncrementHintLevel|ResetHintLevel"
  key_links:
    - from: Hint button click
      to: TutorContext.HintLevel
      via: SetHintLevel method
      pattern: "HintLevel.*increment"
    - from: Execution error
      to: Tutor with error context
      via: UpdateStudentState
      pattern: "ExecutionError.*debug"
---

<objective>
Implement progressive hint system (3 levels) and debug assistance triggered by code execution failures.

Purpose: Students learn better when guided to solutions rather than given answers. Progressive hints provide scaffolding - starting with a nudge, then guidance, then partial solutions. Debug assistance connects errors to lesson concepts.
Output: Hint level enum, UI controls for hint requests, logic to escalate hints, automatic debug mode on execution errors.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@native-app-wpf/Controls/TutorChat.xaml
@native-app-wpf/Controls/TutorChat.xaml.cs
@native-app-wpf/Models/TutorContext.cs

## Current Quick Actions (in TutorChat.xaml)

```xml
<WrapPanel x:Name="QuickActionsPanel">
    <Button Content="Explain this code"
            Style="{StaticResource QuickActionButton}"
            Tag="explain"
            Click="QuickAction_Click"/>
    <Button Content="Help with error"
            Style="{StaticResource QuickActionButton}"
            Tag="error"
            Click="QuickAction_Click"/>
    <Button Content="Give me a hint"
            Style="{StaticResource QuickActionButton}"
            Tag="hint"
            Click="QuickAction_Click"/>
</WrapPanel>
```

## Current QuickAction Handler (in TutorChat.xaml.cs)

```csharp
private void QuickAction_Click(object sender, RoutedEventArgs e)
{
    if (sender is Button button && button.Tag is string action)
    {
        var prompt = action switch
        {
            "explain" => "Can you explain what this code does step by step?",
            "error" => "I'm getting an error. Can you help me understand what's wrong?",
            "hint" => "I'm stuck. Can you give me a hint without giving away the answer?",
            _ => string.Empty
        };

        if (!string.IsNullOrEmpty(prompt))
        {
            InputTextBox.Text = prompt;
            _ = SendMessageAsync();
        }
    }
}
```

## Current TutorContext (from 08-02)

Has HintLevel property (int 0-3) but no logic to manage hint progression.

## Progressive Hint Levels

- **Level 0 (None)**: No hint requested yet
- **Level 1 (Nudge)**: Point in right direction without revealing solution
  - "Think about what happens when the loop reaches the last element"
  - "Consider what data type your function returns"
- **Level 2 (Guidance)**: More specific guidance with partial explanation
  - "You need to check if the index is within bounds before accessing the array"
  - "Remember that string methods return new strings - they don't modify in place"
- **Level 3 (Partial Solution)**: Show approach with key parts to fill in
  - "Try this pattern: `if (index >= 0 && index < array.Length)` then your code"
  - "Use `variable = variable.Trim()` to remove whitespace"

## Debug Assistance Trigger

When ExecutionError is set in TutorContext, the tutor should:
1. Acknowledge the error type
2. Connect it to lesson concepts
3. Ask guiding questions about the fix
4. Not immediately provide the solution
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HintLevel enum</name>
  <files>native-app-wpf/Models/HintLevel.cs</files>
  <action>
Create a new file native-app-wpf/Models/HintLevel.cs with an enum for type-safe hint levels:

```csharp
namespace CodeTutor.Wpf.Models;

/// <summary>
/// Represents the progressive hint levels for the Socratic tutor
/// </summary>
public enum HintLevel
{
    /// <summary>
    /// No hint requested yet
    /// </summary>
    None = 0,
    
    /// <summary>
    /// Level 1: Nudge - Point in the right direction without revealing solution
    /// Examples: "Think about what happens when...", "Consider the data type..."
    /// </summary>
    Nudge = 1,
    
    /// <summary>
    /// Level 2: Guidance - More specific guidance with partial explanation
    /// Examples: "You need to check bounds before...", "Remember that strings..."
    /// </summary>
    Guidance = 2,
    
    /// <summary>
    /// Level 3: Partial Solution - Show approach with key parts to fill in
    /// Examples: "Try this pattern: if (index >= 0 && index < length)..."
    /// </summary>
    PartialSolution = 3
}

/// <summary>
/// Extension methods for HintLevel
/// </summary>
public static class HintLevelExtensions
{
    /// <summary>
    /// Gets the display name for a hint level
    /// </summary>
    public static string GetDisplayName(this HintLevel level) => level switch
    {
        HintLevel.None => "No hint",
        HintLevel.Nudge => "Nudge",
        HintLevel.Guidance => "Guidance",
        HintLevel.PartialSolution => "Partial solution",
        _ => "Unknown"
    };
    
    /// <summary>
    /// Gets a description of what this hint level provides
    /// </summary>
    public static string GetDescription(this HintLevel level) => level switch
    {
        HintLevel.None => "No hint requested yet",
        HintLevel.Nudge => "A gentle push in the right direction",
        HintLevel.Guidance => "Specific guidance about the approach",
        HintLevel.PartialSolution => "Solution structure with gaps to fill",
        _ => "Unknown hint level"
    };
    
    /// <summary>
    /// Increments the hint level, capping at PartialSolution
    /// </summary>
    public static HintLevel Increment(this HintLevel level)
    {
        return level switch
        {
            HintLevel.None => HintLevel.Nudge,
            HintLevel.Nudge => HintLevel.Guidance,
            HintLevel.Guidance => HintLevel.PartialSolution,
            HintLevel.PartialSolution => HintLevel.PartialSolution,
            _ => HintLevel.Nudge
        };
    }
}
```

This provides type safety and clear documentation for hint levels.
  </action>
  <verify>Test-Path native-app-wpf/Models/HintLevel.cs</verify>
  <done>HintLevel.cs exists with enum and extension methods</done>
</task>

<task type="auto">
  <name>Task 2: Update TutorContext to use HintLevel enum</name>
  <files>native-app-wpf/Models/TutorContext.cs</files>
  <action>
Update TutorContext.cs to use the HintLevel enum instead of int:

1. Add using statement: `using static CodeTutor.Wpf.Models.HintLevel;`
2. Change the HintLevel property from `int?` to `HintLevel`

```csharp
// OLD:
public int? HintLevel { get; set; } // 0=none, 1=nudge, 2=guidance, 3=solution

// NEW:
public HintLevel CurrentHintLevel { get; set; } = HintLevel.None;
```

3. Add helper methods for hint management:

```csharp
/// <summary>
/// Increments the hint level for progressive disclosure
/// </summary>
public void IncrementHintLevel()
{
    CurrentHintLevel = CurrentHintLevel.Increment();
}

/// <summary>
/// Resets hint level when starting a new challenge
/// </summary>
public void ResetHintLevel()
{
    CurrentHintLevel = HintLevel.None;
}

/// <summary>
/// Gets the hint level as a number for the prompt
/// </summary>
public int GetHintLevelNumber() => (int)CurrentHintLevel;
```

4. Update the SetHintLevel method call in the prompt building to use CurrentHintLevel.
  </action>
  <verify>(Select-String -Path native-app-wpf/Models/TutorContext.cs -Pattern "CurrentHintLevel").Count -gt 0</verify>
  <done>TutorContext uses HintLevel enum with CurrentHintLevel property</done>
</task>

<task type="auto">
  <name>Task 3: Update TutorChat UI for progressive hint controls</name>
  <files>native-app-wpf/Controls/TutorChat.xaml</files>
  <action>
Update TutorChat.xaml to add progressive hint UI controls:

1. Add a hint level indicator in the header (next to status):

After the StatusText block in the header StackPanel, add:
```xml
<TextBlock x:Name="HintLevelText"
           Text=""
           FontSize="11"
           Margin="12,0,0,0"
           Foreground="{StaticResource AccentPurpleBrush}"
           Visibility="Collapsed"/>
```

2. Replace the simple quick actions with progressive hint buttons:

Replace the entire QuickActionsPanel WrapPanel with:
```xml
<WrapPanel x:Name="QuickActionsPanel">
    <Button Content="Explain this"
            Style="{StaticResource QuickActionButton}"
            Tag="explain"
            Click="QuickAction_Click"/>
    <Button Content="I need a hint"
            Style="{StaticResource QuickActionButton}"
            Tag="hint"
            Click="HintButton_Click"/>
    <Button x:Name="MoreHelpButton"
            Content="More help"
            Style="{StaticResource QuickActionButton}"
            Tag="more_help"
            Click="MoreHelpButton_Click"
            Visibility="Collapsed"/>
    <Button Content="Help with error"
            Style="{StaticResource QuickActionButton}"
            Tag="error"
            Click="ErrorHelpButton_Click"/>
</WrapPanel>
```

3. The "More help" button starts collapsed and becomes visible after first hint request.

Keep all other UI elements unchanged.
  </action>
  <verify>(Select-String -Path native-app-wpf/Controls/TutorChat.xaml -Pattern "I need a hint|More help|HintLevelText").Count -ge 3</verify>
  <done>TutorChat.xaml has hint request buttons and hint level indicator</done>
</task>

<task type="auto">
  <name>Task 4: Implement progressive hint logic in TutorChat.xaml.cs</name>
  <files>native-app-wpf/Controls/TutorChat.xaml.cs</files>
  <action>
Update TutorChat.xaml.cs with progressive hint logic:

1. Add using statement: `using static CodeTutor.Wpf.Models.HintLevel;`

2. Add field to track hint request state:
```csharp
private bool _hintRequested = false;
```

3. Add new event handlers for hint buttons:

```csharp
/// <summary>
/// Handles "I need a hint" button - requests first hint (Nudge)
/// </summary>
private void HintButton_Click(object sender, RoutedEventArgs e)
{
    _currentContext.ResetHintLevel();
    _currentContext.IncrementHintLevel(); // Goes to Nudge
    _hintRequested = true;
    
    UpdateHintLevelDisplay();
    
    InputTextBox.Text = "I'm stuck on this challenge. Can you give me a hint?";
    _ = SendMessageAsync();
}

/// <summary>
/// Handles "More help" button - escalates hint level
/// </summary>
private void MoreHelpButton_Click(object sender, RoutedEventArgs e)
{
    if (_currentContext.CurrentHintLevel < HintLevel.PartialSolution)
    {
        _currentContext.IncrementHintLevel();
        UpdateHintLevelDisplay();
        
        var levelName = _currentContext.CurrentHintLevel.GetDisplayName().ToLower();
        InputTextBox.Text = $"I need more help. Can you give me {levelName}?";
        _ = SendMessageAsync();
    }
    else
    {
        // Already at max level
        InputTextBox.Text = "I'm still stuck. Can you walk me through this step by step?";
        _ = SendMessageAsync();
    }
}

/// <summary>
/// Handles error help button - triggers debug assistance mode
/// </summary>
private void ErrorHelpButton_Click(object sender, RoutedEventArgs e)
{
    if (string.IsNullOrEmpty(_currentContext.ExecutionError))
    {
        // No error yet, just ask about errors in general
        InputTextBox.Text = "I'm getting an error. Can you help me understand what's wrong?";
    }
    else
    {
        // Specific error context available
        InputTextBox.Text = "Can you help me debug this error? What should I look for?";
    }
    _ = SendMessageAsync();
}

/// <summary>
/// Updates the hint level display and button visibility
/// </summary>
private void UpdateHintLevelDisplay()
{
    if (_currentContext.CurrentHintLevel > HintLevel.None)
    {
        HintLevelText.Text = $"Hint: {_currentContext.CurrentHintLevel.GetDisplayName()}";
        HintLevelText.Visibility = Visibility.Visible;
        
        // Show "More help" button after first hint
        if (_currentContext.CurrentHintLevel >= HintLevel.Nudge)
        {
            MoreHelpButton.Visibility = Visibility.Visible;
            MoreHelpButton.Content = _currentContext.CurrentHintLevel < HintLevel.PartialSolution 
                ? "More help" 
                : "Walk me through";
        }
    }
    else
    {
        HintLevelText.Visibility = Visibility.Collapsed;
        MoreHelpButton.Visibility = Visibility.Collapsed;
    }
}
```

4. Update the LoadChallengeContext method to reset hint state:
```csharp
public void LoadChallengeContext(
    string challengeTitle,
    string challengeDescription,
    string starterCode,
    string expectedOutput)
{
    _currentContext.ChallengeTitle = challengeTitle;
    _currentContext.ChallengeDescription = challengeDescription;
    _currentContext.ChallengeStarterCode = starterCode;
    _currentContext.ChallengeExpectedOutput = expectedOutput;
    _currentContext.ResetHintLevel();
    _hintRequested = false;
    UpdateHintLevelDisplay();
}
```

5. Update the existing QuickAction_Click handler to handle the explain case:
```csharp
private void QuickAction_Click(object sender, RoutedEventArgs e)
{
    if (sender is Button button && button.Tag is string action)
    {
        var prompt = action switch
        {
            "explain" => "Can you explain what this code does step by step?",
            _ => string.Empty
        };

        if (!string.IsNullOrEmpty(prompt))
        {
            InputTextBox.Text = prompt;
            _ = SendMessageAsync();
        }
    }
}
```

6. Update UpdateStudentState to trigger debug mode on error:
```csharp
public void UpdateStudentState(string userCode, string? executionError = null, string? actualOutput = null)
{
    _currentContext.UserCode = userCode;
    _currentContext.ExecutionError = executionError;
    _currentContext.ActualOutput = actualOutput;
    
    // If there's an error, the next tutor response should focus on debugging
    // The error context is already in the prompt via BuildPrompt
}
```
  </action>
  <verify>(Select-String -Path native-app-wpf/Controls/TutorChat.xaml.cs -Pattern "HintButton_Click|MoreHelpButton_Click|UpdateHintLevelDisplay").Count -ge 3</verify>
  <done>TutorChat has hint button handlers and display update logic</done>
</task>

<task type="auto">
  <name>Task 5: Update Phi4TutorService to include hint level in prompt</name>
  <files>native-app-wpf/Services/Phi4TutorService.cs</files>
  <action>
Update the BuildPrompt method in Phi4TutorService to include hint level instructions:

In the context injection section (after challenge context, before student state), update the hint level part:

```csharp
// Inject challenge context if available
if (!string.IsNullOrEmpty(context.ChallengeTitle))
{
    sb.AppendLine("");
    sb.AppendLine("=== CHALLENGE CONTEXT ===");
    sb.AppendLine($"Challenge: {context.ChallengeTitle}");
    if (!string.IsNullOrEmpty(context.ChallengeDescription))
        sb.AppendLine($"Description: {context.ChallengeDescription}");
    if (!string.IsNullOrEmpty(context.ChallengeExpectedOutput))
        sb.AppendLine($"Expected Output: {context.ChallengeExpectedOutput}");
    
    // Add hint level instructions
    sb.AppendLine("");
    sb.AppendLine($"Hint Level Requested: {context.CurrentHintLevel.GetDisplayName()} ({context.GetHintLevelNumber()}/3)");
    sb.AppendLine("Hint Guidelines:");
    switch (context.CurrentHintLevel)
    {
        case HintLevel.Nudge:
            sb.AppendLine("- Provide a gentle nudge in the right direction");
            sb.AppendLine("- Ask a guiding question that points toward the solution");
            sb.AppendLine("- Do NOT provide code or specific implementation details");
            sb.AppendLine("- Example: 'Think about what happens when the loop reaches the last element'");
            break;
        case HintLevel.Guidance:
            sb.AppendLine("- Provide specific guidance about the approach");
            sb.AppendLine("- Explain the concept they need to apply");
            sb.AppendLine("- You may show a small code snippet (1-2 lines) if necessary");
            sb.AppendLine("- Do NOT provide the complete solution");
            sb.AppendLine("- Example: 'You need to check if the index is within bounds before accessing the array'");
            break;
        case HintLevel.PartialSolution:
            sb.AppendLine("- Provide the solution structure with key parts to fill in");
            sb.AppendLine("- Show the pattern or approach clearly");
            sb.AppendLine("- Leave specific implementation details for them to complete");
            sb.AppendLine("- Use comments like '// TODO: implement this part' for gaps");
            sb.AppendLine("- Example: 'Try this pattern: if (index >= 0 && index < array.Length) { // your code here }'");
            break;
        default:
            sb.AppendLine("- No hint requested yet - wait for them to ask");
            break;
    }
}
```

Also add a section for debug assistance when there's an execution error:

```csharp
if (!string.IsNullOrEmpty(context.ExecutionError))
{
    sb.AppendLine("");
    sb.AppendLine("=== DEBUG ASSISTANCE MODE ===");
    sb.AppendLine("The student has an execution error. Help them debug by:");
    sb.AppendLine("1. Acknowledging the error type");
    sb.AppendLine("2. Connecting it to the lesson concepts above");
    sb.AppendLine("3. Asking guiding questions about what might cause this error");
    sb.AppendLine("4. Suggesting specific debugging strategies (print statements, tracing, etc.)");
    sb.AppendLine("5. Do NOT immediately provide the fix - guide them to discover it");
    sb.AppendLine("");
    sb.AppendLine("=== EXECUTION ERROR ===");
    sb.AppendLine(context.ExecutionError);
}
```
  </action>
  <verify>(Select-String -Path native-app-wpf/Services/Phi4TutorService.cs -Pattern "HintLevel|DEBUG ASSISTANCE").Count -ge 2</verify>
  <done>Phi4TutorService includes hint level guidelines and debug assistance mode in prompts</done>
</task>

<task type="auto">
  <name>Task 6: Build project to verify compilation</name>
  <files>native-app-wpf/</files>
  <action>
Build the WPF project to verify all changes compile:

```bash
dotnet build native-app-wpf/CodeTutor.Wpf.csproj --configuration Release
```

Check for:
- HintLevel enum usage
- TutorContext property references
- Event handler method signatures
- XAML element name references
  </action>
  <verify>dotnet build native-app-wpf/CodeTutor.Wpf.csproj --configuration Release -v quiet | Select-String "Build succeeded"</verify>
  <done>Build succeeds with 0 errors</done>
</task>

</tasks>

<verification>
Overall phase checks:
- [ ] HintLevel enum exists with None, Nudge, Guidance, PartialSolution values
- [ ] TutorContext uses HintLevel enum (not int)
- [ ] TutorChat has "I need a hint" and "More help" buttons
- [ ] Hint level indicator visible in UI when hints active
- [ ] HintButton_Click resets and requests level 1 hint
- [ ] MoreHelpButton_Click increments hint level
- [ ] Phi4TutorService includes hint level guidelines in prompt
- [ ] Debug assistance mode triggered by ExecutionError
- [ ] Build succeeds with no errors
</verification>

<success_criteria>
- HintLevel enum provides type-safe progressive hint levels
- UI has explicit hint request buttons with escalation
- Hint level displays in UI and resets on new challenge
- Tutor receives hint level context and adjusts response style
- Debug assistance mode provides structured error help
- All code compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/08-ai-tutor-enhancement/08-03-SUMMARY.md`
</output>
